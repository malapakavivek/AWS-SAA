- - - 
### **Introduction**

**Scalability** - application can handle more requests by adapting
- Vertical Scalability - Increase the size of the instance 
	-  `t2.micro` --> `t2.large`
	- use case: distributed databases

- Horizontal Scalability - increasing the number of instances 
	- common for web applications
	- Scale out : increase the no. of instances
	- Scale in: decrease the number of instances

**High Availability** - running your application in at-least 2 AZ's
- Goal is survive AZ loss

![[Pasted image 20240810100932.png|300]]

---
### **Elastic Load Balancing**

- Load Balances are servers that delegate traffic to multiple servers (EC2 instances) 

![[Pasted image 20240810101513.png|400]]

- Why use load balancer? 
	- spread load across multiple instances
	- expose single point of DNS to your application
	- handle failures seamlessly
	- session stickiness
	- separate public traffic 
	- high availability

**Elastic Load Balancer** 
- managed by AWS - maintenance, upgrades etc 
- costs less than setting up our own load balancer 
- integrated with many AWS services 

**Health Checks**
- important to know if our instance is available to reply to requests or not 
- health checks are done on a port and a route usually /health  
- if the instances reply is not 200 (OK), then the instance is unhealthy, the LB will not send traffic to that particular instance.

![[Pasted image 20240810102154.png|300]]

4 Types of managed load balancers :
- ~~Classic Load Balancer  - 2009 - HTTP, HTTPS, TCP, SSL~~ (Deprecated)
- Application Load Balancer - 2016 - HTTP, HTTPS
- Network Load Balancer - 2017 - TCP, TLS, UDP
- Gateway Load Balancer - 2020

![[Pasted image 20240810103126.png|300]]

---
### **Application Load Balancer**

- Layer 7 only load balancer (HTTP)
- load balancing to multiple HTTP applications across machines (target groups)
- load balancing to multiple applications on same machine (containers)

Routing is done by ALB
- Based on path in the URL : example.com/users, example.com/search
- Based on hostname in URL : one.example.com , other.example.com
- based on query : something.com/?id=234

![[Pasted image 20240810104056.png|400]]

Target Groups can be:
- EC2 instances
- ECS tasks
- Lambda Functions
- IP addresses - must be private

![[Pasted image 20240810104354.png|400]]
in the above picture, the traffic is delegated based on the query

- The client doesn't speak directly to the EC2 instance 
- The EC2 instance answers to the requests of the client via the load balancer IP 
- for the instance to see the client's IP by looking at the header in HTTP request called (X-forwarded-for). 
	- X-Forwarded-Port - Port
	- X-forwarded-proto - Protocol

![[Pasted image 20240810112042.png|400]]

---
### **Network Load Balancer**

- Layer 4 Load Balancer - Forwards TCP and UDP traffic to instances
- millions of requests per second 
- very less latency ~100ms , for ALB: ~400ms
- for each AZ - you get an IPv4 address assigned by AWS, but if you have an Elastic IP, you can assign that. 

![[Pasted image 20240810114248.png|400]]

Target Groups can be:
- EC2 instances
- IP addresses - private
- Application Load Balancer 

---
### **Gateway Load Balancer**

- Operates at Layer 3 - IP Packets
- Combination of the following: 
	- single entry/exit for traffic
	- load balancer for 3rd party appliances in target group.
- Target Groups can be 
	- EC2 instances
	- Private IP addresses. 

![[Pasted image 20240810115524.png]]

---
### **Sticky Sessions**

- Same client is always redirected to the same instance behind the Load Balancer. 
- work for CLB, ALB, NLB 

![[Pasted image 20240810120304.png|200]]

- uses "`cookie`" which has an expiration date
- Use Case : when we have to make sure that the user doesn't lost the session data. 

**Cookie**
- Application based cookies 
	- Custom - Generated by target
	- Application - generated by load balancer
- Duration based cookies - generated by load balancer

- We add stickiness to a target group
---
### **Cross - Zone Load Balancing**

![[Pasted image 20240810121630.png|600]]

- For ALB
	- CZLB is on by default (can turn off at target group level)
	- no cost if data is sent from one AZ to another

- For NLB and GWLB:
	- Disabled by default.
	- pay for inter AZ data, if enabled. 

---
### **Connection Draining**

- Time to complete "in-flight requests" which instance is being deregistered 
- Load Balancer will then stop sending requests while being deregistered
- time can be set between 1 to 3600 seconds 

![[Pasted image 20240810122546.png|300]]

---
### **Auto Scaling Groups**

- Goal of Auto Scaling Groups is 
	- Scale out to match the increased load (add EC2)
	- Scale in to match the decreased load (Remove EC2)
	- if EC2 is unhealthy, re-create a new EC2 instance 
	- Automatically attach new instance to load balancer 

![[Pasted image 20240810191727.png|400]]

- Load Balancers conduct health check on EC2 instances 
- Health check is passed onto the ASG and it can remove EC2 instances if they are unhealthy

![[Pasted image 20240810192042.png|400]]

- To create an EC2 instance in an ASG you need a launch template and it consists of 
	- AMI + instance type
	- user data
	- EBS volume
	- Security groups
	- SSH 
	- IAM roles for EC2 instances
	- Load Balancer information
- Need to declare min size / max size and initial capacity for your ASG
- also need to specify scaling policy


- Cloudwatch (service in AWS) is an alarm which triggers the ASG to either scale in or scale out based on few metrics
- Metrics can be CPU utilization, if it's higher than the avg CPU, then scale out 

![[Pasted image 20240810192636.png|400]]

---
### **Auto Scaling Group Policies**

 - **Dynamic Scaling** 
	 - Target Tracking Scaling - eg: I want avg ASG CPU at 40%
	 - Simple/ Step Scaling 
		 - CPU>70% , add 2 units
		 - CPU<30%, remove 1 

- **Scheduled Scaling** 
	- increase min capacity to 10 instances on friday after 5 pm 
	- increase min capacity to 20 instances when dhoni comes out to bat

- **Predictive Scaling** - Forecast load and schedule scaling actions 

**Good Metrics to Scale on**
- CPU utilization
- RequestCountPerTarget

**Scaling Cooldowns**
- after a scaling activity, you are in cooldown period
- during this period, ASG will not launch or terminate any instances (to allow for the meter to stabilize) 

---

Date : 10/08/2024
Vivek Malapaka

---
